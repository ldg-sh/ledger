name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Detect which packages changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.filter.outputs.rust }}
      typescript: ${{ steps.filter.outputs.typescript }}
      auth: ${{ steps.filter.outputs.auth }}
      backend: ${{ steps.filter.outputs.backend }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust:
              - 'packages/rust/**'
              - 'apps/auth/**'
              - 'apps/backend/**'
              - 'tools/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
            typescript:
              - 'packages/ts/**'
              - 'apps/web/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
            auth:
              - 'apps/auth/**'
              - 'packages/rust/ledger-common/**'
              - 'packages/rust/ledger-auth-*/**'
            backend:
              - 'apps/backend/**'
              - 'packages/rust/ledger-common/**'
              - 'packages/rust/ledger-backend-*/**'
            web:
              - 'apps/web/**'
              - 'packages/ts/**'

  # Rust checks
  rust-check:
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Format check
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --workspace -- -D warnings

      - name: Test
        run: cargo test --workspace

  # TypeScript checks
  typescript-check:
    needs: changes
    if: needs.changes.outputs.typescript == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Build
        run: pnpm build

  # Build Docker images (only on main/master)
  build-auth:
    needs: [changes, rust-check]
    if: |
      always() &&
      github.ref == 'refs/heads/master' &&
      needs.changes.outputs.auth == 'true' &&
      (needs.rust-check.result == 'success' || needs.rust-check.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      packages: write
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set variables
        id: vars
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/auth/Dockerfile
          push: true
          platforms: linux/${{ matrix.arch }}
          cache-from: type=gha,scope=auth-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=auth-${{ matrix.arch }}
          tags: |
            ghcr.io/ldg-sh/ledger-auth:${{ steps.vars.outputs.hash }}-${{ matrix.arch }}

  build-backend:
    needs: [changes, rust-check]
    if: |
      always() &&
      github.ref == 'refs/heads/master' &&
      needs.changes.outputs.backend == 'true' &&
      (needs.rust-check.result == 'success' || needs.rust-check.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      packages: write
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set variables
        id: vars
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/backend/Dockerfile
          push: true
          platforms: linux/${{ matrix.arch }}
          cache-from: type=gha,scope=backend-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=backend-${{ matrix.arch }}
          tags: |
            ghcr.io/ldg-sh/ledger:${{ steps.vars.outputs.hash }}-${{ matrix.arch }}

  # Create multi-arch manifests
  manifest-auth:
    needs: build-auth
    if: always() && needs.build-auth.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Set variables
        id: vars
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - run: |
          docker buildx imagetools create \
            -t ghcr.io/ldg-sh/ledger-auth:latest \
            ghcr.io/ldg-sh/ledger-auth:${{ steps.vars.outputs.hash }}-amd64 \
            ghcr.io/ldg-sh/ledger-auth:${{ steps.vars.outputs.hash }}-arm64

  manifest-backend:
    needs: build-backend
    if: always() && needs.build-backend.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Set variables
        id: vars
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - run: |
          docker buildx imagetools create \
            -t ghcr.io/ldg-sh/ledger:latest \
            ghcr.io/ldg-sh/ledger:${{ steps.vars.outputs.hash }}-amd64 \
            ghcr.io/ldg-sh/ledger:${{ steps.vars.outputs.hash }}-arm64
